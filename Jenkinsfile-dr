pipeline {
    agent any

    parameters {
        string(name: 'ASG_NAME', defaultValue: 'audit-afs-eng-asg', description: 'Auto Scaling Group name')
        choice(
            name: 'AZ_SUBNET_LIST',
            choices: [
                'eu-west-1a | subnet-012de65bdd1b717ed',
                'eu-west-1b | subnet-09859042e30db68f7',
                'eu-west-1c | subnet-0215d3bb721795457'
            ],
            description: 'Select one or more AZ|Subnet (comma-separated for multiple)'
        )
        choice(name: 'ASG_ACTION', choices: ['detach','attach'], description: 'Choose detach or attach subnets')
    }

    environment {
        AWS_CREDS = credentials('aws-creds')  // Jenkins AWS credentials ID
        AWS_DEFAULT_REGION = 'ap-south-2'
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/KowshikNaga/Audit-afs-eng.git'
            }
        }

        stage('Test AWS Credentials') {
            steps {
                sh '''
                    export AWS_ACCESS_KEY_ID=$AWS_CREDS_USR
                    export AWS_SECRET_ACCESS_KEY=$AWS_CREDS_PSW
                    aws sts get-caller-identity
                '''
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    python3 -m ensurepip --upgrade
                    python3 -m pip install --user boto3
                '''
            }
        }

        stage('Run ASG Subnet Manager') {
            steps {
                sh '''
                    export AWS_ACCESS_KEY_ID=$AWS_CREDS_USR
                    export AWS_SECRET_ACCESS_KEY=$AWS_CREDS_PSW
                    python3 lambda_function.py --asg-name ${ASG_NAME} --subnet-list "${AZ_SUBNET_LIST}" --action ${ASG_ACTION}
                '''
            }
        }
    }
}
